<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ›ãƒ¼ãƒ ç”»é¢</title>
  <style>
    /* --- Modal Form Input & Textarea Styling for Thread Creation --- */
    #thread-modal input,
    #thread-modal textarea {
      border: 1px solid #444;
      background-color: #1e1e1e;
      color: #fff;
      padding: 8px;
      border-radius: 4px;
      width: 100%;
      margin-bottom: 12px;
      box-sizing: border-box;
    }
    #thread-modal button {
      margin-bottom: 0;
    }
    #thread-modal .modal-content,
    #thread-modal > div {
      padding: 20px !important;
    }
    /* --- Chatroom message bubbles (chat-messages area) --- */
    .chat-messages {
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 12px;
      overflow-y: auto;
      height: calc(100vh - 120px);
    }
    /* --- New chat bubble UI --- */
    .chat-message {
      display: flex;
      align-items: flex-end;
      margin: 8px 0;
      background: none;
      border: none;
    }
    /* è‡ªåˆ†ã®é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ«ï¼ˆå³å¯„ã›ï¼‰ */
    .chat-message.my-message,
    .chat-message.self {
      align-self: flex-end;
      text-align: right;
    }
    .chat-message.my-message .chat-bubble,
    .chat-message.self .chat-bubble {
      background-color: #e0e0e0;
      color: #222;
      margin-left: 40px;
      margin-right: 0;
    }
    /* ç›¸æ‰‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å·¦å¯„ã›ï¼ˆæ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ */
    .chat-message.other-message .chat-bubble {
      background-color: #2e2e2e;
      color: white;
      margin-left: 0;
      margin-right: 40px;
    }
    .chat-user-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin: 0 8px 0 0;
      object-fit: cover;
      background-color: #444;
      flex-shrink: 0;
    }
    .chat-bubble {
      max-width: 60%;
      padding: 10px 14px;
      border-radius: 18px;
      background-color: #2e2e2e;
      color: white;
      word-wrap: break-word;
      font-size: 15px;
      line-height: 1.5;
      border: none;
      box-shadow: none;
      display: flex;
      flex-direction: column;
    }
    .my-message .chat-bubble {
      background-color: #4a4a4a;
    }
    .other-message .chat-bubble {
      background-color: #2e2e2e;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin: 0 8px;
      object-fit: cover;
      background-color: #444;
    }
    .timestamp {
      font-size: 11px;
      color: #aaa;
      margin-top: 4px;
      text-align: right;
    }
    .message-row {
      display: flex;
      align-items: flex-end;
      margin-bottom: 4px;
    }
    .message-row.sent {
      flex-direction: row-reverse;
      justify-content: flex-end;
    }
    .message-row.received {
      flex-direction: row;
      justify-content: flex-start;
    }
    .message-bubble {
      font-size: 15px;
      color: #fff;
      background: none !important;
      border: none !important;
      box-shadow: none !important;
    }
    .message-row.sent .message-bubble {
      background: none !important;
      color: #fff;
      border: none !important;
      box-shadow: none !important;
    }
    .message-row.received .message-bubble {
      background: none !important;
      color: #fff;
      border: none !important;
      box-shadow: none !important;
    }
    /* --- General layout --- */
    body {
      margin: 0;
      font-family: "Helvetica Neue", sans-serif;
      background-color: #121212;
      color: white;
      padding-bottom: 60px;
    }
    header {
      background-color: #1e1e1e;
      padding: 12px 16px;
      border-bottom: 1px solid #2c2c2c;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    .section {
      padding: 16px;
      border-bottom: 1px solid #2c2c2c;
    }
    .section h2 {
      margin-bottom: 12px;
      font-size: 16px;
    }
    .thread-card {
      background-color: #2a2a2a;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .thread-card .meta {
    /* --- End Modal Form Input & Textarea Styling --- */
      font-size: 12px;
      color: #bbbbbb;
    }
    .thread-card .content {
      margin-top: 6px;
      font-size: 14px;
    }
    .user-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 8px;
    }
  </style>
<!-- ã‚µãƒ³ãƒ—ãƒ«: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”»é¢ï¼ˆmessage.htmlæƒ³å®šï¼‰ -->
</head>
<body>
  <div id="registration-screen" style="display: none;">
  <h1 style="text-align: center; font-size: 28px; color: white; margin-top: 40px;">ã‚ˆã†ã“ã</h1>
  <div class="section" style="display: flex; flex-direction: column; align-items: center; height: 100vh; justify-content: center;">
    <div style="width: 120px; height: 120px; border-radius: 20px; overflow: hidden; margin-bottom: 16px; background-color: #444; position: relative;">
      <img id="registration-profile-image" src="" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ" style="width: 100%; height: 100%; object-fit: cover;">
      <input type="file" accept="image/*" onchange="updateRegistrationProfileImage(event)" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;">
    </div>

    <input type="text" placeholder="åå‰ã‚’å…¥åŠ›" style="width: 80%; padding: 10px; margin-bottom: 12px; border-radius: 8px; border: none;">
    <select style="width: 80%; padding: 10px; margin-bottom: 12px; border-radius: 8px; border: none;">
      <option value="">éƒ½é“åºœçœŒã‚’é¸æŠ</option>
      <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
      <option value="é’æ£®çœŒ">é’æ£®çœŒ</option>
      <option value="å²©æ‰‹çœŒ">å²©æ‰‹çœŒ</option>
      <option value="å®®åŸçœŒ">å®®åŸçœŒ</option>
      <option value="ç§‹ç”°çœŒ">ç§‹ç”°çœŒ</option>
      <option value="å±±å½¢çœŒ">å±±å½¢çœŒ</option>
      <option value="ç¦å³¶çœŒ">ç¦å³¶çœŒ</option>
      <option value="èŒ¨åŸçœŒ">èŒ¨åŸçœŒ</option>
      <option value="æ ƒæœ¨çœŒ">æ ƒæœ¨çœŒ</option>
      <option value="ç¾¤é¦¬çœŒ">ç¾¤é¦¬çœŒ</option>
      <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
      <option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
      <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
      <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
      <option value="æ–°æ½ŸçœŒ">æ–°æ½ŸçœŒ</option>
      <option value="å¯Œå±±çœŒ">å¯Œå±±çœŒ</option>
      <option value="çŸ³å·çœŒ">çŸ³å·çœŒ</option>
      <option value="ç¦äº•çœŒ">ç¦äº•çœŒ</option>
      <option value="å±±æ¢¨çœŒ">å±±æ¢¨çœŒ</option>
      <option value="é•·é‡çœŒ">é•·é‡çœŒ</option>
      <option value="å²é˜œçœŒ">å²é˜œçœŒ</option>
      <option value="é™å²¡çœŒ">é™å²¡çœŒ</option>
      <option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option>
      <option value="ä¸‰é‡çœŒ">ä¸‰é‡çœŒ</option>
      <option value="æ»‹è³€çœŒ">æ»‹è³€çœŒ</option>
      <option value="äº¬éƒ½åºœ">äº¬éƒ½åºœ</option>
      <option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option>
      <option value="å…µåº«çœŒ">å…µåº«çœŒ</option>
      <option value="å¥ˆè‰¯çœŒ">å¥ˆè‰¯çœŒ</option>
      <option value="å’Œæ­Œå±±çœŒ">å’Œæ­Œå±±çœŒ</option>
      <option value="é³¥å–çœŒ">é³¥å–çœŒ</option>
      <option value="å³¶æ ¹çœŒ">å³¶æ ¹çœŒ</option>
      <option value="å²¡å±±çœŒ">å²¡å±±çœŒ</option>
      <option value="åºƒå³¶çœŒ">åºƒå³¶çœŒ</option>
      <option value="å±±å£çœŒ">å±±å£çœŒ</option>
      <option value="å¾³å³¶çœŒ">å¾³å³¶çœŒ</option>
      <option value="é¦™å·çœŒ">é¦™å·çœŒ</option>
      <option value="æ„›åª›çœŒ">æ„›åª›çœŒ</option>
      <option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ</option>
      <option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option>
      <option value="ä½è³€çœŒ">ä½è³€çœŒ</option>
      <option value="é•·å´çœŒ">é•·å´çœŒ</option>
      <option value="ç†Šæœ¬çœŒ">ç†Šæœ¬çœŒ</option>
      <option value="å¤§åˆ†çœŒ">å¤§åˆ†çœŒ</option>
      <option value="å®®å´çœŒ">å®®å´çœŒ</option>
      <option value="é¹¿å…å³¶çœŒ">é¹¿å…å³¶çœŒ</option>
      <option value="æ²–ç¸„çœŒ">æ²–ç¸„çœŒ</option>
    </select>
    <input type="number" placeholder="å¹´é½¢" style="width: 80%; padding: 10px; margin-bottom: 12px; border-radius: 8px; border: none;">

    <button onclick="registerUser()" style="width: 80%; padding: 12px; background-color: #4caf50; color: white; border: none; border-radius: 8px; font-size: 16px;">
      ä»Šã™ãå‚åŠ 
    </button>
  </div>
</div>
  <div id="home-screen">
    <header>
      <h1>ãƒ›ãƒ¼ãƒ </h1>
    </header>

    <div class="section" id="recommended-threads">
      <h2>ãŠã™ã™ã‚ã®ã‚¹ãƒ¬</h2>
      <div class="thread-card">
        <div class="meta">åŒ¿åãƒ»2025/08/22</div>
        <div class="content">ä»Šæ—¥ã‚‚å¤œãƒ’ãƒãªäººã€œğŸ¥ºé›‘è«‡ã—ã‚ˆï¼</div>
      </div>
      <div class="thread-card">
        <div class="meta">åŒ¿åãƒ»2025/08/21</div>
        <div class="content">æ·±å¤œãƒ†ãƒ³ã‚·ãƒ§ãƒ³èªã‚ŠãŸã„äººé›†åˆğŸ”¥</div>
      </div>
    </div>

    <div class="section" id="news">
      <h2>é‹å–¶ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</h2>
      <div class="thread-card">
        <div class="meta">2025/08/20</div>
        <div class="content">ãƒã‚°ä¿®æ­£ã¨UIæ”¹å–„ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’è¡Œã„ã¾ã—ãŸï¼</div>
      </div>
    </div>
  </div>
  <div id="chatroom" style="display:none;">
    <div id="chatroom-list-section">
      <header>
        <h1>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </h1>
      </header>
      <div class="section" style="padding: 0;">
        <div id="chat-list" style="padding: 0 0 0 0;">
          <!-- ä¼šè©±ç›¸æ‰‹ãƒªã‚¹ãƒˆãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </div>
      </div>
    </div>
    <div id="chatroom-room-section" style="display:none; height: 100vh; flex-direction: column;">
      <header style="background-color: #1e1e1e; padding: 12px 16px; border-bottom: 1px solid #2c2c2c; display: flex; align-items: center;">
        <button onclick="closeChatRoom()" style="background: none; border: none; color: #fff; font-size: 22px; margin-right: 12px; cursor: pointer;">â†</button>
        <img id="chat-partner-icon" src="https://via.placeholder.com/40" alt="ã‚¢ã‚¤ã‚³ãƒ³" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover; background-color: #444; margin-right: 10px;">
        <span id="chat-partner-name" style="font-size: 18px; font-weight: bold;"></span>
      </header>
      <!-- Chat messages area for bubbles -->
      <div id="chat-messages" class="chat-messages">
        <!-- message bubbles will be appended here -->
      </div>
      <div id="chat-input-bar" style="position: fixed; bottom: 0; left: 0; width: 100%; background: #222; display: flex; align-items: center; padding: 10px 12px; border-top: 1px solid #2c2c2c; z-index: 100;">
        <button style="background: none; border: none; color: #ff4081; font-size: 22px; margin-right: 8px; cursor: pointer;">ğŸ¤</button>
        <button style="background: none; border: none; color: #4caf50; font-size: 22px; margin-right: 8px; cursor: pointer;">ğŸ–¼ï¸</button>
        <input type="text" id="chat-input-text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" style="flex:1; padding: 10px; border-radius: 20px; border: none; outline: none; background: #2a2a2a; color: white; margin-right: 8px;">
        <button id="chat-send-btn" style="background: #4caf50; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 18px; display: flex; align-items: center; justify-content: center;">â–¶ï¸</button>
      </div>
    </div>
  </div>

<!-- The appendMessageBubble function is now wrapped in a script tag and moved to the end of body. -->

  <div id="search" style="display:none;">
    <header>
      <h1>æ¤œç´¢</h1>
    </header>
    <div class="section">
      <div style="position: fixed; bottom: 70px; right: 20px;">
        <div onclick="openPostPopup()" style="width: 56px; height: 56px; background-color: #ff4081; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3); cursor: pointer;">
          <span style="font-size: 24px; color: white;">âœ</span>
        </div>
      </div>
    </div>
  </div>

  <div id="post-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background-color: #1e1e1e; padding: 20px; border-radius: 10px; width: 80%;">
      <textarea id="post-content" placeholder="ã„ã¾ã©ã†ã—ã¦ã‚‹ï¼Ÿ" style="width: 100%; height: 100px; padding: 10px; border-radius: 6px; border: none; background-color: #2a2a2a; color: white;"></textarea>
      <button onclick="submitPost()" style="margin-top: 12px; width: 100%; padding: 10px; background-color: #ff4081; color: white; border: none; border-radius: 6px;">æŠ•ç¨¿</button>
    </div>
  </div>

    <div id="thread" style="display:none;">
      <!-- ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <header class="header" id="thread-list-header">
        <h1 class="header-title" id="header-title" style="text-align: center;">ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h1>
      </header>
      <div id="thread-list" style="display:block;">
        <div class="thread-list">
          <div id="thread-list">
            <!-- ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
          </div>
        </div>
      </div>
      <!-- å³ä¸‹ã®ï¼‹ãƒœã‚¿ãƒ³ -->
      <div id="thread-fab" style="position: fixed; bottom: 70px; right: 20px; z-index: 1200; display: flex;">
        <div onclick="openThreadModal()" style="width: 56px; height: 56px; background-color: #ff4081; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.3); cursor: pointer;">
          <span style="font-size: 32px; color: white; font-weight: bold;">ï¼‹</span>
        </div>
      </div>
      <!-- ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
      <div id="thread-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 1300; justify-content: center; align-items: center;">
        <div style="background: #222; padding: 24px 18px 18px 18px; border-radius: 12px; width: 90%; max-width: 400px; box-sizing: border-box;">
          <h2 style="margin-top:0; margin-bottom:16px; color:white; font-size:20px;">ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h2>
          <input id="thread-name-input" type="text" placeholder="ã‚¹ãƒ¬ãƒƒãƒ‰å" style="width: 100%; padding: 10px; margin-bottom: 12px; border-radius: 8px; border: none; background: #2a2a2a; color: white;">
          <textarea id="thread-desc-input" placeholder="ã‚¹ãƒ¬ãƒƒãƒ‰èª¬æ˜ï¼ˆä»»æ„ï¼‰" style="width: 100%; height: 60px; padding: 10px; margin-bottom: 12px; border-radius: 8px; border: none; background: #2a2a2a; color: white;"></textarea>
          <button onclick="createThread()" style="width: 100%; padding: 12px; background: #ff4081; color: white; border: none; border-radius: 8px; font-size: 16px;">ä½œæˆ</button>
          <button onclick="closeThreadModal()" style="width: 100%; padding: 10px; margin-top: 8px; background: none; color: #bbb; border: none; border-radius: 8px; font-size: 15px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
      <!-- ã‚¹ãƒ¬ãƒƒãƒ‰å€‹åˆ¥ãƒšãƒ¼ã‚¸ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆï¼‰ -->
      <div id="thread-room-section" style="display: none; height: 100vh; flex-direction: column;">
        <header style="background-color: #1e1e1e; padding: 12px 16px; border-bottom: 1px solid #2c2c2c; display: flex; align-items: center; position: sticky; top: 0; z-index: 10;">
          <button onclick="closeThreadRoom()" style="background: none; border: none; color: #fff; font-size: 22px; margin-right: 12px; cursor: pointer;">â†</button>
          <span id="thread-room-title" style="font-size: 18px; font-weight: bold;"></span>
        </header>
        <div id="thread-messages" class="chat-messages" style="height: calc(100vh - 120px);"></div>
        <div id="thread-input-bar" style="position: fixed; bottom: 0; left: 0; width: 100%; background: #222; display: flex; align-items: center; padding: 10px 12px; border-top: 1px solid #2c2c2c; z-index: 1001;">
          <input type="text" id="thread-input-text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" style="flex:1; padding: 10px; border-radius: 20px; border: none; outline: none; background: #2a2a2a; color: white; margin-right: 8px;">
          <button id="thread-send-btn" style="background: #ff4081; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 18px; display: flex; align-items: center; justify-content: center;">â–¶ï¸</button>
        </div>
      </div>
    </div>
  <style>
    .thread-list {
      margin-top: 60px;
    }
    .thread-list-header {
      position: sticky;
      top: 0;
      background-color: #121212;
      text-align: center;
      padding: 12px 0;
      font-weight: bold;
      font-size: 18px;
      z-index: 100;
    }
  </style>
<script>
// ---------------------- ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ ----------------------
// ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ã¯localStorageã§å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å…±é€š
const THREADS_KEY = "peerchat_threads_v1";
const THREAD_MESSAGES_KEY = "peerchat_thread_messages_v1";
function getThreads() {
  try {
    return JSON.parse(localStorage.getItem(THREADS_KEY)) || [];
  } catch(e) {
    return [];
  }
}
function saveThreads(threads) {
  localStorage.setItem(THREADS_KEY, JSON.stringify(threads));
}
function getThreadMessages() {
  try {
    return JSON.parse(localStorage.getItem(THREAD_MESSAGES_KEY)) || {};
  } catch(e) {
    return {};
  }
}
function saveThreadMessages(msgs) {
  localStorage.setItem(THREAD_MESSAGES_KEY, JSON.stringify(msgs));
}
function renderThreadList() {
  const threads = getThreads();
  const list = document.getElementById("thread-list");
  list.innerHTML = "";
  if (!threads.length) {
    const none = document.createElement("div");
    none.style.color = "#aaa";
    none.style.textAlign = "center";
    none.style.margin = "20px 0";
    none.textContent = "ã¾ã ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸‹ã®ï¼‹ã‹ã‚‰ä½œæˆã§ãã¾ã™ã€‚";
    list.appendChild(none);
    return;
  }
  threads.forEach(thread => {
    const card = document.createElement("div");
    card.className = "thread-card";
    card.style.cursor = "pointer";
    card.onclick = () => openThreadRoom(thread.id);
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å–å¾—
    let displayName = thread.authorName;
    if (displayName === undefined || displayName === null || displayName === "" || displayName === "åŒ¿å") {
      displayName = "æœªè¨­å®š";
    }
    card.innerHTML = `
      <div class="meta">${escapeHtml(displayName)}ãƒ»${thread.createdAt}</div>
      <div class="content" style="font-weight:bold; font-size:16px;">${escapeHtml(thread.name)}</div>
      <div class="content" style="margin-top:3px; color:#bbb;">${escapeHtml(thread.desc || "")}</div>
    `;
    list.appendChild(card);
  });
}
function openThreadModal() {
  document.getElementById("thread-modal").style.display = "flex";
  document.getElementById("thread-name-input").value = "";
  document.getElementById("thread-desc-input").value = "";
}
function closeThreadModal() {
  document.getElementById("thread-modal").style.display = "none";
}
function createThread() {
  const name = document.getElementById("thread-name-input").value.trim();
  const desc = document.getElementById("thread-desc-input").value.trim();
  if (!name) {
    alert("ã‚¹ãƒ¬ãƒƒãƒ‰åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  const threads = getThreads();
  const id = "thread_" + Date.now();
  const authorName = localStorage.getItem("profileName") || "åŒ¿å";
  const createdAt = (function() {
    const now = new Date();
    return now.getFullYear() + "/" + ("0"+(now.getMonth()+1)).slice(-2) + "/" + ("0"+now.getDate()).slice(-2);
  })();
  threads.unshift({
    id, name, desc, authorName, createdAt
  });
  saveThreads(threads);
  closeThreadModal();
  renderThreadList();
}
function escapeHtml(str) {
  if (!str) return "";
  return str.replace(/[&<>"']/g, function(m) {
    return ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    })[m];
  });
}
// ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆç”»é¢
let currentThreadId = null;
function openThreadRoom(threadId) {
  currentThreadId = threadId;
  document.getElementById("thread-list").style.display = "none";
  document.getElementById("thread-fab").style.display = "none";
  document.getElementById("thread-room-section").style.display = "flex";
  // Hide ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ header
  var threadListHeader = document.getElementById("thread-list-header");
  if (threadListHeader) threadListHeader.style.display = "none";
  // ã‚¿ã‚¤ãƒˆãƒ«
  const threads = getThreads();
  const thread = threads.find(t => t.id === threadId);
  document.getElementById("thread-room-title").textContent = thread ? thread.name : "";
  renderThreadMessages();
  scrollThreadToBottom();
}
function closeThreadRoom() {
  document.getElementById("thread-list").style.display = "block";
  document.getElementById("thread-fab").style.display = "flex";
  document.getElementById("thread-room-section").style.display = "none";
  // Show ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ header
  var threadListHeader = document.getElementById("thread-list-header");
  if (threadListHeader) threadListHeader.style.display = "block";
  currentThreadId = null;
  renderThreadList();
}
function renderThreadMessages() {
  const container = document.getElementById("thread-messages");
  container.innerHTML = "";
  if (!currentThreadId) return;
  const threadMsgs = getThreadMessages();
  const msgs = threadMsgs[currentThreadId] || [];
  msgs.forEach(msg => {
    let senderType, avatarUrl;
    if (msg.senderId === getMyUserId()) {
      senderType = "me";
      avatarUrl = getMyUserIcon();
    } else {
      senderType = "other";
      avatarUrl = msg.senderIcon || "./noimage.png";
    }
    appendThreadMessageBubble(senderType, msg.text, avatarUrl, msg.senderName, msg.time);
  });
}
function appendThreadMessageBubble(sender, message, userPhotoUrl, senderName, timestamp) {
  const container = document.getElementById("thread-messages");
  if (!container) return;
  const msgText = (message && message.trim() !== "") ? message : "ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—ï¼‰";
  const photo = userPhotoUrl || './noimage.png';
  let timeStr = timestamp;
  if (!timeStr) {
    const now = new Date();
    timeStr = ("0"+now.getHours()).slice(-2) + ":" + ("0"+now.getMinutes()).slice(-2);
  }
  // message-row
  const row = document.createElement("div");
  row.className = "message-row " + (sender === "me" ? "sent" : "received");
  // avatar
  const img = document.createElement("img");
  img.className = "avatar";
  img.src = photo;
  img.alt = "ã‚¢ã‚¤ã‚³ãƒ³";
  img.onerror = function() { this.src = "./noimage.png"; };
  // bubble
  const bubble = document.createElement("div");
  bubble.className = "message-bubble";
  // æŠ•ç¨¿è€…åï¼ˆè‡ªåˆ†ä»¥å¤–ã®ã¿ï¼‰
  if (sender !== "me") {
    const nameDiv = document.createElement("div");
    nameDiv.style.fontSize = "12px";
    nameDiv.style.color = "#aaa";
    nameDiv.style.marginBottom = "2px";
    let displayName = senderName;
    if (displayName === undefined || displayName === null || displayName === "" || displayName === "åŒ¿å") {
      displayName = "æœªè¨­å®š";
    }
    nameDiv.textContent = displayName;
    bubble.appendChild(nameDiv);
  }
  // ãƒ†ã‚­ã‚¹ãƒˆ
  const textDiv = document.createElement("div");
  textDiv.textContent = msgText;
  bubble.appendChild(textDiv);
  // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  const tsDiv = document.createElement("div");
  tsDiv.className = "timestamp";
  tsDiv.textContent = timeStr;
  bubble.appendChild(tsDiv);
  // ä¸¦ã³é †
  if (sender === "me") {
    row.appendChild(bubble);
    row.appendChild(img);
  } else {
    row.appendChild(img);
    row.appendChild(bubble);
  }
  container.appendChild(row);
}
function sendThreadMessage() {
  const input = document.getElementById("thread-input-text");
  const text = input.value.trim();
  if (!text || !currentThreadId) return;
  const now = new Date();
  const timeString = now.getFullYear() + "/" + ("0"+(now.getMonth()+1)).slice(-2) + "/" + ("0"+now.getDate()).slice(-2) + " " + ("0"+now.getHours()).slice(-2) + ":" + ("0"+now.getMinutes()).slice(-2);
  const myName = localStorage.getItem("profileName") || "åŒ¿å";
  const myIcon = getMyUserIcon();
  const myId = getMyUserId();
  // ä¿å­˜
  const threadMsgs = getThreadMessages();
  if (!threadMsgs[currentThreadId]) threadMsgs[currentThreadId] = [];
  threadMsgs[currentThreadId].push({
    senderId: myId,
    senderName: myName,
    senderIcon: myIcon,
    text: text,
    time: timeString
  });
  saveThreadMessages(threadMsgs);
  input.value = "";
  renderThreadMessages();
  scrollThreadToBottom();
}
function scrollThreadToBottom() {
  setTimeout(() => {
    const container = document.getElementById("thread-messages");
    if (container) container.scrollTop = container.scrollHeight;
  }, 50);
}
function getMyUserId() {
  // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆç«¯æœ«ã”ã¨ï¼‰
  let id = localStorage.getItem("myUserId");
  if (!id) {
    id = "me_" + Math.random().toString(36).slice(2,10);
    localStorage.setItem("myUserId", id);
  }
  return id;
}

// ã‚¹ãƒ¬ãƒƒãƒ‰ç”»é¢è¡¨ç¤ºæ™‚
document.getElementById("thread").addEventListener("show", function() {
  document.getElementById("thread-list").style.display = "block";
  document.getElementById("thread-fab").style.display = "flex";
  document.getElementById("thread-room-section").style.display = "none";
  // Show ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ header
  var threadListHeader = document.getElementById("thread-list-header");
  if (threadListHeader) threadListHeader.style.display = "block";
  renderThreadList();
});
// FAB/ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.addEventListener("mousedown", function(e) {
  const modal = document.getElementById("thread-modal");
  if (modal && modal.style.display !== "none" && !modal.firstElementChild.contains(e.target)) {
    closeThreadModal();
  }
});
// é€ä¿¡ãƒœã‚¿ãƒ³ãƒ»Enteré€ä¿¡
document.addEventListener("DOMContentLoaded", function() {
  const threadSendBtn = document.getElementById("thread-send-btn");
  if (threadSendBtn) threadSendBtn.onclick = sendThreadMessage;
  const threadInput = document.getElementById("thread-input-text");
  if (threadInput) {
    threadInput.addEventListener("keydown", function(e) {
      if (e.key === "Enter") sendThreadMessage();
    });
  }
});
</script>

  <div id="settings" style="display:none;">
    <header>
      <h1>è¨­å®š</h1>
    </header>
    <div class="section">
      <h2>è¨­å®š</h2>
      <div class="thread-card">
    <div class="content">
      <div style="text-align: center; margin-bottom: 16px;">
        <img id="profileImage" src="" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ" onerror="this.src='data:image/svg+xml;utf8,&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;100&quot; height=&quot;100&quot;&gt;&lt;rect width=&quot;100&quot; height=&quot;100&quot; fill=&quot;%23444&quot;/&gt;&lt;text x=&quot;50%&quot; y=&quot;50%&quot; dominant-baseline=&quot;middle&quot; text-anchor=&quot;middle&quot; fill=&quot;%23aaa&quot; font-size=&quot;12&quot;&gt;NO IMAGE&lt;/text&gt;&lt;/svg&gt;'" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; background-color: #444;">
        <br>
        <span id="profileImageText" style="color: #aaa; font-size: 14px; cursor: pointer;">å¤‰æ›´</span>
        <input type="file" id="profileImageInput" accept="image/*" style="display: none;">
      </div>
      <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h3>
      <div style="margin-bottom: 12px;">
        <label for="profile-name">åå‰:</label><br>
        <input type="text" id="profile-name" style="width: 100%; padding: 8px; border-radius: 6px; border: none;">
      </div>
      <div style="margin-bottom: 12px;">
        <label for="profile-location">ä½ã‚“ã§ã„ã‚‹åœ°åŸŸ:</label><br>
        <select id="profile-location" style="width: 100%; padding: 8px; border-radius: 6px; border: none;">
          <option value="">éƒ½é“åºœçœŒã‚’é¸æŠ</option>
          <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
          <option value="é’æ£®çœŒ">é’æ£®çœŒ</option>
          <option value="å²©æ‰‹çœŒ">å²©æ‰‹çœŒ</option>
          <option value="å®®åŸçœŒ">å®®åŸçœŒ</option>
          <option value="ç§‹ç”°çœŒ">ç§‹ç”°çœŒ</option>
          <option value="å±±å½¢çœŒ">å±±å½¢çœŒ</option>
          <option value="ç¦å³¶çœŒ">ç¦å³¶çœŒ</option>
          <option value="èŒ¨åŸçœŒ">èŒ¨åŸçœŒ</option>
          <option value="æ ƒæœ¨çœŒ">æ ƒæœ¨çœŒ</option>
          <option value="ç¾¤é¦¬çœŒ">ç¾¤é¦¬çœŒ</option>
          <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
          <option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
          <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
          <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
          <option value="æ–°æ½ŸçœŒ">æ–°æ½ŸçœŒ</option>
          <option value="å¯Œå±±çœŒ">å¯Œå±±çœŒ</option>
          <option value="çŸ³å·çœŒ">çŸ³å·çœŒ</option>
          <option value="ç¦äº•çœŒ">ç¦äº•çœŒ</option>
          <option value="å±±æ¢¨çœŒ">å±±æ¢¨çœŒ</option>
          <option value="é•·é‡çœŒ">é•·é‡çœŒ</option>
          <option value="å²é˜œçœŒ">å²é˜œçœŒ</option>
          <option value="é™å²¡çœŒ">é™å²¡çœŒ</option>
          <option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option>
          <option value="ä¸‰é‡çœŒ">ä¸‰é‡çœŒ</option>
          <option value="æ»‹è³€çœŒ">æ»‹è³€çœŒ</option>
          <option value="äº¬éƒ½åºœ">äº¬éƒ½åºœ</option>
          <option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option>
          <option value="å…µåº«çœŒ">å…µåº«çœŒ</option>
          <option value="å¥ˆè‰¯çœŒ">å¥ˆè‰¯çœŒ</option>
          <option value="å’Œæ­Œå±±çœŒ">å’Œæ­Œå±±çœŒ</option>
          <option value="é³¥å–çœŒ">é³¥å–çœŒ</option>
          <option value="å³¶æ ¹çœŒ">å³¶æ ¹çœŒ</option>
          <option value="å²¡å±±çœŒ">å²¡å±±çœŒ</option>
          <option value="åºƒå³¶çœŒ">åºƒå³¶çœŒ</option>
          <option value="å±±å£çœŒ">å±±å£çœŒ</option>
          <option value="å¾³å³¶çœŒ">å¾³å³¶çœŒ</option>
          <option value="é¦™å·çœŒ">é¦™å·çœŒ</option>
          <option value="æ„›åª›çœŒ">æ„›åª›çœŒ</option>
          <option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ</option>
          <option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option>
          <option value="ä½è³€çœŒ">ä½è³€çœŒ</option>
          <option value="é•·å´çœŒ">é•·å´çœŒ</option>
          <option value="ç†Šæœ¬çœŒ">ç†Šæœ¬çœŒ</option>
          <option value="å¤§åˆ†çœŒ">å¤§åˆ†çœŒ</option>
          <option value="å®®å´çœŒ">å®®å´çœŒ</option>
          <option value="é¹¿å…å³¶çœŒ">é¹¿å…å³¶çœŒ</option>
          <option value="æ²–ç¸„çœŒ">æ²–ç¸„çœŒ</option>
        </select>
      </div>
      <div style="margin-bottom: 12px;">
        <label for="profile-age">å¹´é½¢:</label><br>
        <input type="number" id="profile-age" style="width: 100%; padding: 8px; border-radius: 6px; border: none;">
      </div>
      <button onclick="saveProfile()" style="width: 100%; padding: 10px; background-color: #4caf50; color: white; border: none; border-radius: 8px;">
        ä¿å­˜ã™ã‚‹
      </button>
    </div>
  </div>
    </div>
  </div>

<footer style="position: fixed; bottom: 0; width: 100%; background-color: #1e1e1e; border-top: 1px solid #2c2c2c; display: none; justify-content: space-around; align-items: center; padding: 8px 0;">
  <div style="color: #bbb; font-size: 18px;" onclick="showScreen('search')">ğŸ”</div>
  <div style="color: #bbb; font-size: 18px;" onclick="showScreen('chatroom')">âœ‰ï¸</div>
  <div style="background-color: black; border-radius: 50%; padding: 6px;" onclick="showScreen('home-screen')">
    <div style="color: white; font-size: 20px;">ğŸ </div>
  </div>
  <div style="color: #bbb; font-size: 18px;" onclick="showScreen('thread')">ğŸ§µ</div>
  <div style="color: #bbb; font-size: 18px;" onclick="showScreen('settings')">âš™ï¸</div>
</footer>
  <!-- The main script block moved here from the top of the file -->
<!-- The main script block moved here from the top of the file -->
<script>
// appendMessageBubble utility for chat-messages area
// sender: "me" or "other"
// message: text (string), can be empty or undefined
// userPhotoUrl: optional, fallback to './no-image.png' if not provided
// timestamp: optional string (e.g. 16:40), if not provided, show current time
function appendMessageBubble(sender, message, userPhotoUrl, timestamp) {
  const container = document.getElementById("chat-messages");
  if (!container) return;
  const msgText = (message && message.trim() !== "") ? message : "ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—ï¼‰";
  const photo = userPhotoUrl || './no-image.png';
  let timeStr = timestamp;
  if (!timeStr) {
    const now = new Date();
    timeStr = ("0"+now.getHours()).slice(-2) + ":" + ("0"+now.getMinutes()).slice(-2);
  }
  // .chat-message wrapper
  const row = document.createElement("div");
  row.className = "chat-message " + (sender === "me" ? "my-message" : "other-message");
  // icon
  const img = document.createElement("img");
  img.className = "chat-user-icon";
  img.src = photo;
  img.alt = "ã‚¢ã‚¤ã‚³ãƒ³";
  img.onerror = function() { this.src = "./no-image.png"; };
  // bubble
  const bubble = document.createElement("div");
  bubble.className = "chat-bubble";
  bubble.textContent = msgText;
  // timestamp
  const tsDiv = document.createElement("div");
  tsDiv.className = "timestamp";
  tsDiv.textContent = timeStr;
  bubble.appendChild(tsDiv);
  // order: icon left for other, right for me
  if (sender === "me") {
    row.appendChild(bubble);
    row.appendChild(img);
  } else {
    row.appendChild(img);
    row.appendChild(bubble);
  }
  container.appendChild(row);
  // --- Console log for tracing message append
  console.log("Appending message bubble:", sender, msgText, timeStr);
}

function showScreen(screenId) {
  const screens = ['home-screen', 'chatroom', 'search', 'thread', 'settings', 'registration-screen'];
  screens.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.style.display = (id === screenId) ? 'block' : 'none';
      if (id === screenId) el.dispatchEvent(new Event("show"));
    }
  });
  const footer = document.querySelector("footer");
  if (footer) {
    footer.style.display = (screenId === "registration-screen") ? "none" : "flex";
  }
}

window.onload = function () {
  const isRegistered = localStorage.getItem("isRegistered");
  if (isRegistered) {
    showScreen('home-screen');
  } else {
    showScreen('registration-screen');
  }
}

function registerUser() {
  localStorage.setItem("isRegistered", true);
  saveUserProfileToServer();
  showScreen('home-screen');
  loadProfileImage();
}

function updateRegistrationProfileImage(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    const imgData = e.target.result;
    localStorage.setItem("profileImage", imgData);
    document.getElementById("registration-profile-image").src = imgData;
  };
  reader.readAsDataURL(file);
}

function saveProfile() {
  const name = document.getElementById("profile-name").value;
  const location = document.getElementById("profile-location").value;
  const age = document.getElementById("profile-age").value;
  localStorage.setItem("profileName", name);
  localStorage.setItem("profileLocation", location);
  localStorage.setItem("profileAge", age);
  saveUserProfileToServer();
  alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
}
// ã‚µãƒ¼ãƒãƒ¼ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°ï¼ˆFirebase Firestoreã¸ç›´æ¥ä¿å­˜ï¼‰
import { db } from './firebase.js';
import { doc, setDoc } from 'firebase/firestore';

async function saveUserProfileToServer() {
  const name = document.getElementById("profile-name")?.value || localStorage.getItem("profileName") || "";
  const location = document.getElementById("profile-location")?.value || localStorage.getItem("profileLocation") || "";
  const age = document.getElementById("profile-age")?.value || localStorage.getItem("profileAge") || "";
  const image = localStorage.getItem("profileImage") || "";

  const userId = localStorage.getItem("myUserId");
  if (!userId) return;

  try {
    await setDoc(doc(db, "users", userId), {
      name,
      location,
      age,
      image
    });
    console.log("Firestoreã«ä¿å­˜ã—ã¾ã—ãŸ");
  } catch (error) {
    console.error("Firestoreä¿å­˜å¤±æ•—:", error);
  }
}

function loadProfile() {
  document.getElementById("profile-name").value = localStorage.getItem("profileName") || "";
  document.getElementById("profile-location").value = localStorage.getItem("profileLocation") || "";
  document.getElementById("profile-age").value = localStorage.getItem("profileAge") || "";
  loadProfileImage();
}

function updateProfileImage(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    const imgData = e.target.result;
    localStorage.setItem("profileImage", imgData);
    document.getElementById("profile-image").src = imgData;
  };
  reader.readAsDataURL(file);
}

function loadProfileImage() {
  // For backward compatibility, set both ids if present
  const savedImage = localStorage.getItem("profileImage");
  const img1 = document.getElementById("profile-image");
  const img2 = document.getElementById("profileImage");
  if (img1) {
    if (savedImage) {
      img1.src = savedImage;
    } else {
      img1.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' fill='%23444'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23aaa' font-size='12'>NO IMAGE</text></svg>";
    }
  }
  if (img2) {
    if (savedImage) {
      img2.src = savedImage;
    } else {
      img2.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' fill='%23444'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23aaa' font-size='12'>NO IMAGE</text></svg>";
    }
  }
}

// è‡ªå‹•èª­ã¿è¾¼ã¿
document.getElementById("settings").addEventListener("show", loadProfile);

function openPostPopup() {
  document.getElementById("post-popup").style.display = "flex";
}

function submitPost() {
  const content = document.getElementById("post-content").value;
  if (content.trim() === "") return;
  const postCard = document.createElement("div");
  postCard.className = "thread-card";
  const profileImage = localStorage.getItem("profileImage") || "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' fill='%23444'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23aaa' font-size='12'>NO IMAGE</text></svg>";
  postCard.innerHTML = `
    <div style="display: flex; align-items: center;">
      <img src="${profileImage}" alt="ã‚¢ã‚¤ã‚³ãƒ³" onclick="showUserProfile()" style="cursor: pointer; width: 36px; height: 36px; border-radius: 50%; object-fit: cover; margin-right: 12px; background-color: #444;">
      <div>
        <div class="meta">ã‚ãªãŸãƒ»${new Date().toLocaleDateString()}</div>
        <div class="content">${content}</div>
      </div>
    </div>
  `;
  document.querySelector("#search .section").appendChild(postCard);
  document.getElementById("post-popup").style.display = "none";
  document.getElementById("post-content").value = "";
}

function showUserProfile() {
  const profileImage = localStorage.getItem("profileImage");
  document.getElementById("preview-profile-image").src = profileImage || "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' fill='%23444'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23aaa' font-size='12'>NO IMAGE</text></svg>";
  const name = localStorage.getItem("profileName") || "æœªè¨­å®š";
  const location = localStorage.getItem("profileLocation") || "æœªè¨­å®š";
  const age = localStorage.getItem("profileAge") || "æœªè¨­å®š";
  document.getElementById("preview-name").innerText = "åå‰: " + name;
  document.getElementById("preview-location").innerText = "åœ°åŸŸ: " + location;
  document.getElementById("preview-age").innerText = "å¹´é½¢: " + age;
  document.getElementById("user-preview").style.display = "block";
  // ã€Œã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  const messageButton = document.getElementById("message-user-button");
  if (messageButton) {
    messageButton.onclick = function () {
      startMessageWithUser(name);
    };
  }
}

function startMessageWithUser(userName) {
  showScreen('chatroom');
  const chatSection = document.querySelector("#chatroom .section");
  chatSection.innerHTML = `
    <h2>${userName}ã¨ã®ãƒãƒ£ãƒƒãƒˆ</h2>
    <div class="thread-card">
      <div class="meta">${userName}ãƒ»${new Date().toLocaleDateString()}</div>
      <div class="content">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚</div>
    </div>
  `;
}

// --- Chat Data Mockup ---
// --- åˆæœŸåŒ–ç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ ---
const users = [
  {
    id: "yuko",
    name: "ã‚†ã†ã“",
    region: "æ±äº¬",
    age: "24",
    icon: "noimage.png"
  },
  {
    id: "takashi",
    name: "ãŸã‹ã—",
    region: "å¤§é˜ª",
    age: "30",
    icon: "noimage.png"
  },
  {
    id: "mayu",
    name: "ã¾ã‚†",
    region: "åå¤å±‹",
    age: "22",
    icon: "noimage.png"
  }
];

// ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ä¸€è¦§ã«åˆæœŸè¡¨ç¤ºç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
const messages = {
  "yuko": [{ sender: "yuko", text: "ã“ã‚“ã«ã¡ã¯ï¼" }],
  "takashi": [{ sender: "takashi", text: "ã‚„ã‚ï¼" }],
  "mayu": [{ sender: "mayu", text: "ã‚ˆã‚ã—ãã­ã€œ" }]
};

let currentChatUserId = null;
let currentChatUserIndex = null;

function getUserIcon(user) {
  if (user.icon && user.icon !== "") return user.icon;
  return "./noimage.png";
}

function getLastMessage(userId) {
  if (!messages[userId] || messages[userId].length === 0) return "";
  return messages[userId][messages[userId].length - 1].text;
}

function renderChatList() {
  const listContainer = document.getElementById("chat-list");
  if (!listContainer) return;
  listContainer.innerHTML = "";
  users.forEach((user) => {
    const div = document.createElement("div");
    div.className = "thread-card";
    div.style.cursor = "pointer";
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.padding = "12px";
    div.style.borderRadius = "0";
    div.style.borderBottom = "1px solid #222";
    div.style.background = "none";
    div.style.margin = "0";

    // Profile Icon
    const icon = document.createElement("img");
    icon.src = getUserIcon(user);
    icon.alt = "ã‚¢ã‚¤ã‚³ãƒ³";
    icon.style.width = "40px";
    icon.style.height = "40px";
    icon.style.borderRadius = "50%";
    icon.style.objectFit = "cover";
    icon.style.backgroundColor = "#444";
    icon.style.marginRight = "12px";

    // Content wrapper
    const contentWrapper = document.createElement("div");
    contentWrapper.style.flex = "1";
    contentWrapper.style.display = "flex";
    contentWrapper.style.flexDirection = "column";
    contentWrapper.style.justifyContent = "center";

    const name = document.createElement("div");
    name.style.fontWeight = "bold";
    name.style.marginBottom = "2px";
    name.innerText = user.name;

    const lastMessage = document.createElement("div");
    lastMessage.style.fontSize = "13px";
    lastMessage.style.color = "#ccc";
    lastMessage.style.whiteSpace = "nowrap";
    lastMessage.style.overflow = "hidden";
    lastMessage.style.textOverflow = "ellipsis";
    lastMessage.innerText = getLastMessage(user.id) || "ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“";

    contentWrapper.appendChild(name);
    contentWrapper.appendChild(lastMessage);
    div.appendChild(icon);
    div.appendChild(contentWrapper);

    div.onclick = () => openChatWithUser(user.id);
    listContainer.appendChild(div);
  });
}

function openChatWithUser(userId) {
  currentChatUserId = userId;
  document.getElementById("chatroom-list-section").style.display = "none";
  document.getElementById("chatroom-room-section").style.display = "flex";

  const user = users.find(u => u.id === userId);
  if (!user) return;
  document.getElementById("chat-partner-name").innerText = user.name;
  document.getElementById("chat-partner-icon").src = getUserIcon(user);
  renderChatMessages();
  scrollChatToBottom();
}

function closeChatRoom() {
  document.getElementById("chatroom-list-section").style.display = "block";
  document.getElementById("chatroom-room-section").style.display = "none";
  currentChatUserId = null;
  renderChatList();
}

// Helper: get user's own icon (avatar)
function getMyUserIcon() {
  const savedImage = localStorage.getItem("profileImage");
  return savedImage || "./noimage.png";
}

function renderChatMessages() {
  const container = document.getElementById("chat-messages");
  if (!container) return;
  container.innerHTML = "";
  if (!currentChatUserId) return;
  const user = users.find(u => u.id === currentChatUserId);
  if (!user) return;
  const msgs = messages[currentChatUserId] || [];
  msgs.forEach(msg => {
    let senderType, avatarUrl;
    if (msg.sender === currentChatUserId) {
      senderType = "other";
      avatarUrl = getUserIcon(user);
    } else {
      senderType = "me";
      avatarUrl = getMyUserIcon();
    }
    appendMessageBubble(senderType, msg.text, avatarUrl, msg.time);
  });
}

function sendChatMessage() {
  const input = document.getElementById("chat-input-text");
  const text = input.value.trim();
  if (!text || !currentChatUserId) return;
  const now = new Date();
  const timeString = now.getFullYear() + "/" + ("0"+(now.getMonth()+1)).slice(-2) + "/" + ("0"+now.getDate()).slice(-2) + " " + ("0"+now.getHours()).slice(-2) + ":" + ("0"+now.getMinutes()).slice(-2);
  // push to messages
  if (!messages[currentChatUserId]) messages[currentChatUserId] = [];
  messages[currentChatUserId].push({
    sender: "me",
    text: text,
    time: timeString
  });
  input.value = "";
  appendMessageBubble("me", text, getMyUserIcon(), timeString);
  scrollChatToBottom();
}

function scrollChatToBottom() {
  setTimeout(() => {
    const container = document.getElementById("chat-messages");
    if (container) container.scrollTop = container.scrollHeight;
  }, 50);
}

document.addEventListener("DOMContentLoaded", function() {
  renderChatList();
  // Bind send button in chatroom-room-section
  const chatSendBtn = document.getElementById("chat-send-btn");
  if (chatSendBtn) {
    chatSendBtn.onclick = sendChatMessage;
  }
  // Enter key for input
  const chatInput = document.getElementById("chat-input-text");
  if (chatInput) {
    chatInput.addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        sendChatMessage();
      }
    });
  }
});

// When switching to chatroom, always show the list UI
document.getElementById("chatroom").addEventListener("show", function() {
  document.getElementById("chatroom-list-section").style.display = "block";
  document.getElementById("chatroom-room-section").style.display = "none";
  currentChatUserId = null;
  renderChatList();
});
// ã‚‚ã—ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒ <script type="module"> ã§ãªã‘ã‚Œã°ã€ä¸Šè¨˜ import æ–‡ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
</script>
</script>
<style>
/* ã‚¹ãƒ¬ãƒƒãƒ‰å€‹åˆ¥ãƒ«ãƒ¼ãƒ ç”»é¢ã®ã¨ãã¯ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éš ã™ */
#thread-room-section[style*="display: flex"] ~ #thread-list-header,
#thread-room-section[style*="display: flex"] ~ header.header,
#thread-room-section[style*="display: flex"] ~ .header {
  display: none !important;
}
#thread-room-section[style*="display: flex"] ~ #thread-list {
  display: none !important;
}
#thread-room-section[style*="display: flex"] ~ #thread-fab {
  display: none !important;
}
/* ãŸã ã—ä¸Šè¨˜ã¯å…„å¼Ÿè¦ç´ ã ã¨åŠ¹ã‹ãªã„ã®ã§JSã§åˆ¶å¾¡ */
</style>
<script>
// ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆthread-room-sectionãŒè¡¨ç¤ºä¸­ã¯headerã‚’éš ã™ï¼‰
function updateThreadListHeaderVisibility() {
  var threadRoomSection = document.getElementById("thread-room-section");
  var threadListHeader = document.getElementById("thread-list-header");
  if (!threadListHeader) return;
  if (threadRoomSection && threadRoomSection.style.display === "flex") {
    threadListHeader.style.display = "none";
  } else {
    threadListHeader.style.display = "block";
  }
}
// ãƒ•ãƒƒã‚¯: ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ«ãƒ¼ãƒ ã‚’é–‹é–‰ã—ãŸã¨ãã«ãƒ˜ãƒƒãƒ€ãƒ¼åˆ¶å¾¡
const _origOpenThreadRoom = window.openThreadRoom;
window.openThreadRoom = function(threadId) {
  _origOpenThreadRoom.call(this, threadId);
  updateThreadListHeaderVisibility();
};
const _origCloseThreadRoom = window.closeThreadRoom;
window.closeThreadRoom = function() {
  _origCloseThreadRoom.call(this);
  updateThreadListHeaderVisibility();
};
// ã‚¹ãƒ¬ãƒƒãƒ‰ç”»é¢è¡¨ç¤ºæ™‚ã«ã‚‚åˆ¶å¾¡
document.getElementById("thread").addEventListener("show", updateThreadListHeaderVisibility);
</script>
</body>
<div id="user-preview" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #121212; z-index: 1100; overflow: auto; flex-direction: column;">
  <header style="background-color: #1e1e1e; padding: 12px 16px; border-bottom: 1px solid #2c2c2c; display: flex; justify-content: space-between; align-items: center;">
    <h2 style="margin: 0; color: white;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
    <button onclick="document.getElementById('user-preview').style.display='none'" style="color: white; background: none; border: none; font-size: 20px;">âœ•</button>
  </header>
  <div style="flex: 1; text-align: center; margin-top: 40px;">
    <img id="preview-profile-image" src="" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ" onerror="this.src='data:image/svg+xml;utf8,&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;100&quot; height=&quot;100&quot;&gt;&lt;rect width=&quot;100&quot; height=&quot;100&quot; fill=&quot;%23444&quot;/&gt;&lt;text x=&quot;50%&quot; y=&quot;50%&quot; dominant-baseline=&quot;middle&quot; text-anchor=&quot;middle&quot; fill=&quot;%23aaa&quot; font-size=&quot;12&quot;&gt;NO IMAGE&lt;/text&gt;&lt;/svg&gt;'" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; background-color: #444;"><br><br>
    <p id="preview-name" style="color: white;"></p>
    <p id="preview-location" style="color: white;"></p>
    <p id="preview-age" style="color: white;"></p>
  </div>
  <footer style="background-color: #1e1e1e; padding: 10px; border-top: 1px solid #2c2c2c; text-align: center;">
    <span style="color: #888;">PeerChat Â© 2025</span>
    <br><button id="message-user-button" style="margin-top: 12px; padding: 10px 20px; background-color: #4caf50; color: white; border: none; border-radius: 6px;">ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã™ã‚‹</button>
  </footer>
</div>


</script>

</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const profileImageText = document.querySelector('#profileImageText');
    const profileImageInput = document.querySelector('#profileImageInput');
    if (profileImageText && profileImageInput) {
      profileImageText.addEventListener('click', () => {
        profileImageInput.click();
      });
      profileImageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const imgEl = document.querySelector('#profileImage');
            if (imgEl) imgEl.src = e.target.result;
            localStorage.setItem('profileImage', e.target.result);
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // On load, show saved image if exists
    const savedImage = localStorage.getItem('profileImage');
    if (savedImage) {
      const imgEl = document.querySelector('#profileImage');
      if (imgEl) imgEl.src = savedImage;
    }
  });
</script>